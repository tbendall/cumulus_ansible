---


- name: Bootstrap SSH key using password auth; optionally harden sshd
  hosts: all
  gather_facts: false
  become: false

#  vars:
#    ssh_home: "{{ (target_user == 'root') | ternary('/root', '/home/' ~ target_user) }}"
#    ssh_dir: "{{ ssh_home }}/.ssh"
#
#  handlers:
#    - name: restart sshd
#      ansible.builtin.service:
#        # Debian/Ubuntu use 'ssh', RHEL/CentOS/Alma/Rocky/SUSE use 'sshd'
#        name: "{{ (ansible_facts['os_family'] == 'Debian') | ternary('ssh', 'sshd') }}"
#        state: restarted
#
#  pre_tasks:
#    - name: Ensure computed home directory path is valid
#      ansible.builtin.assert:
#        that:
#          - ssh_home is match('^/.*')
#        fail_msg: "Computed home '{{ ssh_home }}' seems invalid."

  tasks:


    - name: Try config
      nvidia.nvue.command:
        commands:
        - sudo systemctl enable netq-agent.service
        - sudo systemctl start netq-agent.service
        - netq config add agent gnmi-enable true
        - netq config restart agent
        apply: true
        assume_yes: true
      register: output

    - name: Print NVUE diff for operator review
      ansible.builtin.debug:
        msg: "{{ output }}"




#    - name: Create .ssh directory with secure permissions
#      ansible.builtin.file:
#        path: "{{ ssh_dir }}"
#        state: directory
#        owner: "{{ target_user }}"
#        group: "{{ target_user }}"
#        mode: "0700"
#
#    - name: Install public key into authorized_keys (idempotent)
#      ansible.builtin.authorized_key:
#        user: "{{ target_user }}"
#        state: present
#        key: "{{ ssh_pubkey }}"
#        path: "{{ ssh_authorized_key_path }}"
#        manage_dir: false
#
#    - name: Ensure authorized_keys permissions are strict
#      ansible.builtin.file:
#        path: "{{ ssh_authorized_key_path }}"
#        state: file
#        owner: "{{ target_user }}"
#        group: "{{ target_user }}"
#        mode: "0600"
#
#    - name: Optionally harden sshd (disable password auth after key is in place)
#      when: disable_password_auth
#      block:
#        - name: Ensure PubkeyAuthentication is enabled
#          ansible.builtin.lineinfile:
#            path: /etc/ssh/sshd_config
#            regexp: '^\s*PubkeyAuthentication\s+'
#            line: 'PubkeyAuthentication yes'
#            backup: true
#          notify: restart sshd
#
#        - name: Disable PasswordAuthentication
#          ansible.builtin.lineinfile:
#            path: /etc/ssh/sshd_config
#            regexp: '^\s*PasswordAuthentication\s+'
#            line: 'PasswordAuthentication no'
#            backup: true
#          notify: restart sshd
#
#        - name: Disable ChallengeResponseAuthentication
#          ansible.builtin.lineinfile:
#            path: /etc/ssh/sshd_config
#            regexp: '^\s*ChallengeResponseAuthentication\s+'
#            line: 'ChallengeResponseAuthentication no'
#            backup: true
#          notify: restart sshd
#
#        - name: Flush handlers (restart sshd if config changed)
#          ansible.builtin.meta: flush_handlers
